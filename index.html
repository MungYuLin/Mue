<!doctype html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.0" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.0" />






<meta name="description" content="动漫，美剧，电影爱好者">
<meta property="og:type" content="website">
<meta property="og:title" content="Mandag&#39;s Blog">
<meta property="og:url" content="http://mungyulin.github.io/index.html">
<meta property="og:site_name" content="Mandag&#39;s Blog">
<meta property="og:description" content="动漫，美剧，电影爱好者">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Mandag&#39;s Blog">
<meta name="twitter:description" content="动漫，美剧，电影爱好者">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":0,"b2t":false,"scrollpercent":false},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: 'BI09G1CGTO',
      apiKey: '79af29965237da45de18b4a83aeea996',
      indexName: 'MandagName',
      hits: {"per_page":10},
      labels: {"input_placeholder":"输入关键字进行搜索","hits_empty":"找不到关于“ ${query} ”的文章","hits_stats":"共找到 ${hits} 篇文章，花了 ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://mungyulin.github.io/"/>





  <title> Mandag's Blog </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  














  
  
    
  

  <div class="container sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Mandag's Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">学会生活</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  
  <div class="algolia-popup popup search-popup">
    <div class="algolia-search">
      <div class="algolia-search-input-icon">
        <i class="fa fa-search"></i>
      </div>
      <div class="algolia-search-input" id="algolia-search-input"></div>
    </div>

    <div class="algolia-results">
      <div id="algolia-stats"></div>
      <div id="algolia-hits"></div>
      <div id="algolia-pagination" class="algolia-pagination"></div>
    </div>

    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
  </div>




    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://mungyulin.github.io/2017/07/15/2017-07-15-微信小程序uploadFile/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Mandag">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/icon.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Mandag's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/07/15/2017-07-15-微信小程序uploadFile/" itemprop="url">
                  【JavaScript】wx.uploadFile多个文件上传
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-07-15T20:38:00+08:00">
                2017-07-15
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>今天写微信小程序时，用到 wx.uploadFile，用来上传图片资源信息<br>因为需要多个文件全部上传，都是uploadFile不支持多个连接同时进行<br>所以必须重新进行处理，使之可以自动处理多个文件</p>
<p>为了方便使用，可以先在javascript中对wx.uploadFile重新进行封装</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="comment">// 上传文件</span></div><div class="line">Tools.upload = <span class="function"><span class="keyword">function</span> (<span class="params">ops</span>) </span>&#123;</div><div class="line">    <span class="keyword">var</span> fn = &#123;</div><div class="line">        <span class="attr">success</span>: _empty,</div><div class="line">        <span class="attr">fail</span>: _empty,</div><div class="line">        <span class="attr">complete</span>: _empty</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (ops.success)</div><div class="line">        fn.success = ops.success</div><div class="line">    <span class="keyword">if</span> (ops.fail)</div><div class="line">        fn.fail = ops.fail</div><div class="line">    <span class="keyword">if</span> (ops.complete)</div><div class="line">        fn.complete = ops.complete</div><div class="line"></div><div class="line">    wx.uploadFile(&#123;</div><div class="line">        <span class="attr">url</span>: ops.url,</div><div class="line">        <span class="attr">filePath</span>: ops.filePath,</div><div class="line">        <span class="attr">name</span>: (ops.name == <span class="literal">null</span> || ops.name == <span class="string">""</span> || <span class="keyword">typeof</span> (ops.name) == <span class="string">"undefined"</span>) ? <span class="string">'file'</span> : ops.name,</div><div class="line">        <span class="attr">header</span>: &#123;</div><div class="line">            <span class="string">'Authorization'</span>: <span class="string">'BasicAuth '</span> + wx.getStorageSync(<span class="string">'token'</span>)</div><div class="line">        &#125;,</div><div class="line">        <span class="attr">formData</span>: (ops.formData == <span class="literal">null</span> || <span class="keyword">typeof</span> (ops.formData) == <span class="string">"undefined"</span>) ? &#123;&#125; : ops.formData,</div><div class="line">        <span class="attr">success</span>: <span class="function"><span class="keyword">function</span> (<span class="params">res</span>) </span>&#123;</div><div class="line">            <span class="keyword">if</span> (res.statusCode == <span class="number">200</span>) &#123;</div><div class="line">                <span class="keyword">var</span> _data = Tools.parseJSON(res.data)</div><div class="line">                <span class="keyword">if</span> (_data.errcode == <span class="number">0</span>) &#123;</div><div class="line">                    fn.success(_data.data)</div><div class="line">                &#125; <span class="keyword">else</span> &#123;</div><div class="line">                    fn.fail(_data.message)</div><div class="line">                &#125;</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                Tools.alert(res.data, <span class="string">'error'</span>)</div><div class="line">                fn.fail(res.data.Message)</div><div class="line">            &#125;</div><div class="line">        &#125;,</div><div class="line">        <span class="attr">fail</span>: <span class="function"><span class="keyword">function</span> (<span class="params">res</span>) </span>&#123;</div><div class="line">            fn.fail(res)</div><div class="line">        &#125;,</div><div class="line">        <span class="attr">complete</span>: <span class="function"><span class="keyword">function</span> (<span class="params">res</span>) </span>&#123;</div><div class="line">            fn.complete(res)</div><div class="line">        &#125;</div><div class="line">    &#125;)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>接着通过递归的方式在一个连接完成后，重新调用，代码如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">uploadFile(files) &#123;</div><div class="line">    <span class="keyword">if</span> (!files || files.length &lt;= <span class="number">0</span>) <span class="keyword">return</span></div><div class="line">    <span class="keyword">var</span> that = <span class="keyword">this</span>,</div><div class="line">        file = files[<span class="number">0</span>]</div><div class="line">    files.splice(<span class="number">0</span>, <span class="number">1</span>)</div><div class="line">    $.upload(&#123;</div><div class="line">        <span class="attr">url</span>: that.config.uploadFileUrl, <span class="comment">// api地址</span></div><div class="line">        filePath: file.filePath, <span class="comment">// 资源地址</span></div><div class="line">        name: <span class="string">'uploadfile'</span>,</div><div class="line">        <span class="attr">formData</span>: &#123;</div><div class="line">            <span class="attr">source</span>: file.source, <span class="comment">// 来源信息</span></div><div class="line">            sourceId: file.sourceId <span class="comment">// 来源ID</span></div><div class="line">        &#125;, <span class="comment">// 提交额外 formdata</span></div><div class="line">        success: <span class="function"><span class="keyword">function</span> (<span class="params">res</span>) </span>&#123;</div><div class="line">            <span class="comment">// 提交成功...</span></div><div class="line">        &#125;,</div><div class="line">        <span class="attr">complete</span>: <span class="function"><span class="keyword">function</span> (<span class="params">res</span>) </span>&#123;</div><div class="line">            that.uploadFile(files)</div><div class="line">        &#125;</div><div class="line">    &#125;)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>服务端，接收代码如下：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">[<span class="meta">HttpPost</span>]</div><div class="line">[<span class="meta">AllowAnonymous</span>]</div><div class="line"><span class="function"><span class="keyword">public</span> AjaxResult <span class="title">UploadFile</span>(<span class="params"></span>)</span></div><div class="line">&#123;</div><div class="line">    <span class="comment">// 接收资源文件</span></div><div class="line">    HttpFileCollection hfc = HttpContext.Current.Request.Files;</div><div class="line"></div><div class="line">    <span class="comment">// 接收formdata</span></div><div class="line">    <span class="keyword">string</span> Source = HttpContext.Current.Request[<span class="string">"source"</span>];</div><div class="line">    <span class="keyword">string</span> SourceId = HttpContext.Current.Request[<span class="string">"sourceId"</span>];</div><div class="line"></div><div class="line">    <span class="comment">// 处理...</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://mungyulin.github.io/2017/04/16/2017-04-16-在Mac中调试虚拟机Visual Studio项目/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Mandag">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/icon.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Mandag's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/04/16/2017-04-16-在Mac中调试虚拟机Visual Studio项目/" itemprop="url">
                  【Visual Studio】在Mac中调试虚拟机Visual Studio项目
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-04-16T15:24:00+08:00">
                2017-04-16
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>需要调试在Visual Studio中运行的基于Web的项目，但是要启动调试不用Windows上运行的Web浏览器…<br>而是用在Mac中调试..基于此，找了各种文章和博客文章后，终于搞定了。</p>
<h4 id="配置Parallels设置"><a href="#配置Parallels设置" class="headerlink" title="配置Parallels设置"></a>配置Parallels设置</h4><p>打开Parallels配置，单击[硬件]选项卡，然后选择[网络]，将类型设置为“共享网络”。这允许OS X查看您的Windows虚拟机。<br>再单击[选项]选项卡，然后单击[应用程序]，勾选“与Windows共享Mac应用程序”。</p>
<h4 id="设置IIS站点"><a href="#设置IIS站点" class="headerlink" title="设置IIS站点"></a>设置IIS站点</h4><p>打开IIS，右击[网站]点击[添加网站]填写相关信息，并在[主机名]中填写 项目URL，如：mandag.local</p>
<h4 id="将项目URL添加到Windows主机文件"><a href="#将项目URL添加到Windows主机文件" class="headerlink" title="将项目URL添加到Windows主机文件"></a>将项目URL添加到Windows主机文件</h4><p>打开Windows中Hosts文件，输入以下内容<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">127.0.0.1      mandag.local</div></pre></td></tr></table></figure></p>
<h4 id="将项目URL添加到OSX主机文件"><a href="#将项目URL添加到OSX主机文件" class="headerlink" title="将项目URL添加到OSX主机文件"></a>将项目URL添加到OSX主机文件</h4><p>打开OSX中Hosts文件，输入以下内容<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">192.168.1.76   mandag.local</div></pre></td></tr></table></figure></p>
<h4 id="在MAC打开mandag-local网址即可"><a href="#在MAC打开mandag-local网址即可" class="headerlink" title="在MAC打开mandag.local网址即可"></a>在MAC打开mandag.local网址即可</h4><blockquote>
<p>參考網站：<br><a href="https://dontpaniclabs.com/blog/post/2015/08/25/browser-debugging-between-os-x-and-visual-studio-in-parallels/" target="_blank" rel="external">Browser Debugging Between OS X and Visual Studio in Parallels</a><br><a href="https://www.getdonedone.com/accessing-your-windows-development-environment-from-osx/" target="_blank" rel="external">Accessing Your Windows Development Environment From OSX</a></p>
</blockquote>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://mungyulin.github.io/2017/02/24/2017-02-17-递归获取SKU路径/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Mandag">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/icon.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Mandag's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/02/24/2017-02-17-递归获取SKU路径/" itemprop="url">
                  【NET】设置SKU路径
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-02-24T21:29:00+08:00">
                2017-02-24
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>在做一个商城项目，之前并没有接触过，包括淘宝店铺<br><br>刚开始还有点没头绪，或者在SKU上相差了<br><br>商品有销售分类，类目，规格，属性<br><br>销售分类为商户自定义分类，可多选<br><br>类目为系统固定分类<br><br>规格为商品的规格，如，颜色，尺寸等<br><br>属性为商品的规格属性，如，红色，白色，黑色，均码等<br></p>
<p>在商品关联这项后，修改商品信息：<br><br>如修改XXX牌羊绒毛衣<br><br>根据类目=&gt;规格=&gt;属性<br><br>颜色：白色 黑色 红色 绿色 灰色 黄色 粉色 咖啡色<br><br>尺寸：XXS  XS  S    M    L   XL  XXL  XXXL</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> skuManage = &#123;</div><div class="line">    <span class="attr">template</span>: &#123;</div><div class="line">        <span class="attr">thead</span>: <span class="string">'&lt;thead&gt;&lt;th&gt;序号&lt;/th&gt;&lt;th&gt;组合规格&lt;/th&gt;&lt;th&gt;库存数量&lt;/th&gt;&lt;th&gt;商品价格（元）&lt;/th&gt;&lt;/thead&gt;'</span>,</div><div class="line">        <span class="attr">tr</span>: <span class="string">'&lt;tr&gt;&lt;/tr&gt;'</span>,</div><div class="line">        <span class="attr">td</span>: <span class="string">'&lt;td&gt;&lt;/td&gt;'</span>,</div><div class="line">        <span class="attr">input</span>: <span class="string">'&lt;input type="text" class="form-control" /&gt;'</span></div><div class="line">    &#125;,</div><div class="line">    <span class="attr">selected</span>: &#123;&#125;,</div><div class="line">    <span class="attr">add2Selected</span>: <span class="function"><span class="keyword">function</span> (<span class="params">key, value</span>) </span>&#123;</div><div class="line">        <span class="keyword">var</span> arr = [];</div><div class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.selected[key]) &#123;</div><div class="line">            <span class="keyword">this</span>.selected[key].push(value);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="keyword">this</span>.selected[key] = [value];</div><div class="line">        &#125;</div><div class="line">    &#125;,</div><div class="line">    <span class="attr">pop2Selected</span>: <span class="function"><span class="keyword">function</span> (<span class="params">key, value</span>) </span>&#123;</div><div class="line">        <span class="keyword">this</span>.selected[key].splice($.inArray(value, <span class="keyword">this</span>.selected[key]), <span class="number">1</span>);</div><div class="line">    &#125;,</div><div class="line">    <span class="attr">addSymbols</span>: <span class="function"><span class="keyword">function</span> (<span class="params">skas, choices</span>) </span>&#123;</div><div class="line">        <span class="keyword">var</span> result = [];</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>, len = skas.length; i &lt; len; i++) &#123;</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">var</span> j = <span class="number">0</span>, lenj = choices.length; j &lt; lenj; j++) &#123;</div><div class="line">                result.push(skas[i] + <span class="string">':'</span> + choices[j]);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> result;</div><div class="line">    &#125;,</div><div class="line">    <span class="attr">symbols</span>: <span class="function"><span class="keyword">function</span> (<span class="params">arrs</span>) </span>&#123;</div><div class="line">        <span class="keyword">var</span> skas = arrs[<span class="number">0</span>];</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">1</span>, len = arrs.length; i &lt; len; i++) &#123;</div><div class="line">            skas = <span class="keyword">this</span>.addSymbols(skas, arrs[i]);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> skas;</div><div class="line">    &#125;,</div><div class="line">    <span class="attr">drawPaths</span>: <span class="function"><span class="keyword">function</span> (<span class="params">o</span>) </span>&#123;</div><div class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.count(<span class="keyword">this</span>.selected) &gt; <span class="number">1</span>) &#123;</div><div class="line">            o.empty().append(<span class="keyword">this</span>.template.thead);</div><div class="line">            <span class="keyword">var</span> keys_arr = <span class="keyword">this</span>.objToArr(<span class="keyword">this</span>.selected);</div><div class="line">            <span class="keyword">var</span> keys = <span class="keyword">this</span>.symbols(keys_arr);</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>, len = keys.length ; i &lt; len; i++) &#123;</div><div class="line">                <span class="keyword">var</span> value = [];</div><div class="line">                $.each(keys[i].split(<span class="string">':'</span>), <span class="function"><span class="keyword">function</span> (<span class="params">index, elem</span>) </span>&#123;</div><div class="line">                    <span class="keyword">var</span> _forVal = $(<span class="string">"#pv-"</span> + elem + <span class="string">""</span>).next(<span class="string">'label'</span>)[<span class="number">0</span>];</div><div class="line">                    value.push($(_forVal).html());</div><div class="line">                &#125;)</div><div class="line"></div><div class="line">                o.append($(<span class="keyword">this</span>.template.tr)</div><div class="line">                    .append($(<span class="keyword">this</span>.template.td).append(i + <span class="number">1</span>))</div><div class="line">                    .append($(<span class="keyword">this</span>.template.td).append(value.join(<span class="string">'，'</span>)))</div><div class="line">                    .append($(<span class="keyword">this</span>.template.td).append($(<span class="keyword">this</span>.template.input).attr(<span class="string">'type'</span>, <span class="string">'number'</span>).attr(<span class="string">'attr-pv'</span>, keys[i]).attr(<span class="string">'attr-pvt'</span>, <span class="string">'count'</span>)))</div><div class="line">                    .append($(<span class="keyword">this</span>.template.td).append($(<span class="keyword">this</span>.template.input).attr(<span class="string">'type'</span>, <span class="string">'number'</span>).attr(<span class="string">'attr-pv'</span>, keys[i]).attr(<span class="string">'attr-pvt'</span>, <span class="string">'price'</span>)))</div><div class="line">                );</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;,</div><div class="line">    <span class="attr">count</span>: <span class="function"><span class="keyword">function</span> (<span class="params">o</span>) </span>&#123;</div><div class="line">        <span class="keyword">var</span> t = <span class="keyword">typeof</span> o;</div><div class="line">        <span class="keyword">if</span> (t == <span class="string">'string'</span>) &#123;</div><div class="line">            <span class="keyword">return</span> o.length;</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (t == <span class="string">'object'</span>) &#123;</div><div class="line">            <span class="keyword">var</span> n = <span class="number">0</span>;</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">var</span> i <span class="keyword">in</span> o) &#123;</div><div class="line">                n++;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">return</span> n;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</div><div class="line">    &#125;,</div><div class="line">    <span class="attr">objToArr</span>: <span class="function"><span class="keyword">function</span> (<span class="params">o</span>) </span>&#123;</div><div class="line">        <span class="keyword">var</span> keys = [];</div><div class="line">        $.each(o, <span class="function"><span class="keyword">function</span> (<span class="params">i, row</span>) </span>&#123;</div><div class="line">            <span class="keyword">var</span> key = [];</div><div class="line">            $.each(row, <span class="function"><span class="keyword">function</span> (<span class="params">index, element</span>) </span>&#123;</div><div class="line">                key.push(element);</div><div class="line">            &#125;)</div><div class="line">            keys.push(key);</div><div class="line">        &#125;)</div><div class="line">        <span class="keyword">return</span> keys;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">$(<span class="string">'.sku'</span>).click(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">    <span class="keyword">var</span> $self = $(<span class="keyword">this</span>);</div><div class="line"></div><div class="line">    <span class="keyword">if</span> ($self.is(<span class="string">':checked'</span>)) &#123;</div><div class="line">        skuManage.add2Selected($self.attr(<span class="string">'attr_porid'</span>), $self.attr(<span class="string">'attr_valid'</span>));</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        skuManage.pop2Selected($self.attr(<span class="string">'attr_porid'</span>), $self.attr(<span class="string">'attr_valid'</span>));</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    skuManage.drawPaths($skuTable)</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>通过在属性上绑定事件，使之保存选中项到数组，在重新生成表格，如<br><br>选中了 白色，黑色，红色，S，L，M<br><br>那么就出现了 白色-S，白色—L，白色-M，黑色-S，黑色—L，黑色-M，红色-S，红色—L，红色-M，这几种情况<br><br>填写相应对应的库存和价格<br><br>保存最终的一个结果</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://mungyulin.github.io/2017/02/18/2017-02-17-EntityFramework简单使用/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Mandag">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/icon.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Mandag's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/02/18/2017-02-17-EntityFramework简单使用/" itemprop="url">
                  【NET】EF总结
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-02-18T12:44:00+08:00">
                2017-02-18
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>关于Entity Framework在MVC架构以及在项目中使用小结。</p>
<h4 id="创建sqlproj项目"><a href="#创建sqlproj项目" class="headerlink" title="创建sqlproj项目"></a>创建sqlproj项目</h4><p>在项目中增加sqlproj项目，增加相关表或视图后，发布到数据库；</p>
<h4 id="创建Entity项目"><a href="#创建Entity项目" class="headerlink" title="创建Entity项目"></a>创建Entity项目</h4><p>新建一个Entity项目，创建实体数据模型，会自动把发布的数据库表映射到实体类中；</p>
<h4 id="Context类"><a href="#Context类" class="headerlink" title="Context类"></a>Context类</h4><p>创建一个在项目中可以通用的BaseDBContext类</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">BaseDBContext</span> : <span class="title">DbContext</span></div><div class="line">&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">BaseDBContext</span>(<span class="params"></span>)</span></div><div class="line">        : <span class="title">base</span>(<span class="params"><span class="string">"name=HPDBEntities"</span></span>)</div><div class="line">    &#123;</div><div class="line">        <span class="keyword">this</span>.Configuration.AutoDetectChangesEnabled = <span class="literal">false</span>;</div><div class="line">        <span class="keyword">this</span>.Configuration.ValidateOnSaveEnabled = <span class="literal">false</span>;</div><div class="line">        <span class="keyword">this</span>.Configuration.LazyLoadingEnabled = <span class="literal">false</span>;</div><div class="line">        <span class="keyword">this</span>.Configuration.ProxyCreationEnabled = <span class="literal">false</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="全局通用的操作类"><a href="#全局通用的操作类" class="headerlink" title="全局通用的操作类"></a>全局通用的操作类</h4><p>有了Context类后，我们需要一个对全局通用的操作类EFHelper</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">public class EFHelper&lt;TEntity&gt; where TEntity : class</div><div class="line">&#123;</div><div class="line">    private BaseDBContext dbContext = new BaseDBContext();</div><div class="line"></div><div class="line">    public int Insert(TEntity entity)</div><div class="line">    &#123;</div><div class="line">        dbContext.Entry&lt;TEntity&gt;(entity).State = EntityState.Added;</div><div class="line">        return dbContext.SaveChanges();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public int Insert(List&lt;TEntity&gt; entitys)</div><div class="line">    &#123;</div><div class="line">        foreach (var entity in entitys)</div><div class="line">        &#123;</div><div class="line">            dbContext.Entry&lt;TEntity&gt;(entity).State = EntityState.Added;</div><div class="line">        &#125;</div><div class="line">        return dbContext.SaveChanges();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public int Update(TEntity entity)</div><div class="line">    &#123;</div><div class="line">        dbContext.Set&lt;TEntity&gt;().Attach(entity);</div><div class="line">        PropertyInfo[] props = entity.GetType().GetProperties();</div><div class="line">        foreach (PropertyInfo prop in props)</div><div class="line">        &#123;</div><div class="line">            if (prop.GetValue(entity, null) != null)</div><div class="line">            &#123;</div><div class="line">                if (prop.GetValue(entity, null).ToString() == "&amp;nbsp;")</div><div class="line">                    dbContext.Entry(entity).Property(prop.Name).CurrentValue = null;</div><div class="line">                dbContext.Entry(entity).Property(prop.Name).IsModified = true;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        return dbContext.SaveChanges();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public int Delete(TEntity entity)</div><div class="line">    &#123;</div><div class="line">        dbContext.Set&lt;TEntity&gt;().Attach(entity);</div><div class="line">        dbContext.Entry&lt;TEntity&gt;(entity).State = EntityState.Deleted;</div><div class="line">        return dbContext.SaveChanges();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public int Delete(Expression&lt;Func&lt;TEntity, bool&gt;&gt; predicate)</div><div class="line">    &#123;</div><div class="line">        var entitys = dbContext.Set&lt;TEntity&gt;().Where(predicate).ToList();</div><div class="line">        entitys.ForEach(m =&gt; dbContext.Entry&lt;TEntity&gt;(m).State = EntityState.Deleted);</div><div class="line">        return dbContext.SaveChanges();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public TEntity FindEntity(object keyValue)</div><div class="line">    &#123;</div><div class="line">        return dbContext.Set&lt;TEntity&gt;().Find(keyValue);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public TEntity FindEntity(Expression&lt;Func&lt;TEntity, bool&gt;&gt; where)</div><div class="line">    &#123;</div><div class="line">        return dbContext.Set&lt;TEntity&gt;().FirstOrDefault(where);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public List&lt;TEntity&gt; FindList()</div><div class="line">    &#123;</div><div class="line">        return dbContext.Set&lt;TEntity&gt;().ToList&lt;TEntity&gt;();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public IQueryable&lt;TEntity&gt; IQueryable()</div><div class="line">    &#123;</div><div class="line">        return dbContext.Set&lt;TEntity&gt;();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public IEnumerable&lt;TEntity&gt; IQueryable(Expression&lt;Func&lt;TEntity, bool&gt;&gt; where)</div><div class="line">    &#123;</div><div class="line">        return dbContext.Set&lt;TEntity&gt;().Where(where);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public IEnumerable&lt;TEntity&gt; IQueryable&lt;TKey&gt;(Expression&lt;Func&lt;TEntity, TKey&gt;&gt; orderBy, Pagination pagination)</div><div class="line">    &#123;</div><div class="line">        var tempData = dbContext.Set&lt;TEntity&gt;().AsQueryable();</div><div class="line">        if (!pagination.sort.IsEmpty() &amp;&amp; pagination.sort.Equals("asc"))</div><div class="line">        &#123;</div><div class="line">            tempData = tempData.OrderBy(orderBy);</div><div class="line">        &#125;</div><div class="line">        else</div><div class="line">        &#123;</div><div class="line">            tempData = tempData.OrderByDescending(orderBy);</div><div class="line">        &#125;</div><div class="line">        pagination.records = tempData.Count();</div><div class="line">        tempData = tempData.Skip&lt;TEntity&gt;(pagination.offset).Take&lt;TEntity&gt;(pagination.rows).AsQueryable();</div><div class="line">        return tempData.ToList();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public IEnumerable&lt;TEntity&gt; IQueryable&lt;TKey&gt;(Expression&lt;Func&lt;TEntity, bool&gt;&gt; where, Expression&lt;Func&lt;TEntity, TKey&gt;&gt; orderBy, Pagination pagination)</div><div class="line">    &#123;</div><div class="line">        var tempData = dbContext.Set&lt;TEntity&gt;().AsQueryable();</div><div class="line">        if (!pagination.sort.IsEmpty() &amp;&amp; pagination.sort.Equals("asc"))</div><div class="line">        &#123;</div><div class="line">            tempData = tempData.OrderBy(orderBy);</div><div class="line">        &#125;</div><div class="line">        else</div><div class="line">        &#123;</div><div class="line">            tempData = tempData.OrderByDescending(orderBy);</div><div class="line">        &#125;</div><div class="line">        tempData = tempData.Where(where).AsQueryable();</div><div class="line">        pagination.records = tempData.Count();</div><div class="line">        tempData = tempData.Skip&lt;TEntity&gt;(pagination.offset).Take&lt;TEntity&gt;(pagination.rows).AsQueryable();</div><div class="line">        return tempData.ToList();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>以上可以通用在整个项目的基本操作类</p>
<h4 id="实际使用"><a href="#实际使用" class="headerlink" title="实际使用"></a>实际使用</h4><p>创建了操作类后，就可以直接在项目中进行操作</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">private</span> EFHelper&lt;Entity.T_User&gt; helper = <span class="keyword">new</span> EFHelper&lt;Entity.T_User&gt;();</div><div class="line"></div><div class="line"><span class="comment">// 获取</span></div><div class="line"><span class="keyword">var</span> en = helper.FindEntity(id); <span class="comment">// 主键直接获取</span></div><div class="line"><span class="keyword">var</span> en = helper.FindEntity(m =&gt; m.Name.Equals(name, StringComparison.OrdinalIgnoreCase)); <span class="comment">// 不为主键进行linq进行where</span></div><div class="line"></div><div class="line"><span class="comment">// 新增</span></div><div class="line"><span class="keyword">var</span> en = <span class="keyword">new</span> Entity.T_User() &#123; Id = Guid.NewGuid(), Name = name &#125;;</div><div class="line">helper.Insert(en);</div><div class="line"></div><div class="line"><span class="comment">// 修改</span></div><div class="line"><span class="keyword">var</span> result = helper.FindEntity(id);</div><div class="line"><span class="keyword">if</span> (result != <span class="literal">null</span>)</div><div class="line">&#123;</div><div class="line">    result.Name = name;</div><div class="line">    helper.Update(result);</div><div class="line">&#125;;</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">// 删除</span></div><div class="line"><span class="keyword">var</span> result = helper.FindEntity(userId);</div><div class="line"><span class="keyword">if</span> (result != <span class="literal">null</span>)</div><div class="line">&#123;</div><div class="line">    helper.Delete(result);</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="comment">// 查询</span></div><div class="line"><span class="keyword">var</span> list = helper.IQueryable(m =&gt; m.Name.Contains(keyword));</div></pre></td></tr></table></figure>
<p>如果需要在复杂的地方进行操作，如下</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">var</span> query = helper.IQueryable(m =&gt; m.HasDelete.HasValue &amp; !m.HasDelete.Value);</div><div class="line"><span class="keyword">if</span> (!keyword.IsEmpty())</div><div class="line">&#123;</div><div class="line">    query = query.Where(m =&gt; m.Name.Contains(keyword)).AsQueryable();</div><div class="line">&#125;</div><div class="line"><span class="keyword">var</span> tempData = query.OrderBy(m =&gt; m.Sorting).ToList()</div><div class="line">                    .Join(helper_role.IQueryable(), m =&gt; m.RoleId, c =&gt; c.Id, (m, c) =&gt; <span class="keyword">new</span></div><div class="line">                    &#123;</div><div class="line">                        m.Id,</div><div class="line">                        m.Name</div><div class="line">                        RoleId = c.Id</div><div class="line">                        RoleName = c.Name</div><div class="line">                    &#125;)</div><div class="line">                    .AsQueryable();</div><div class="line">pagination.records = tempData.Count();</div><div class="line"><span class="keyword">var</span> list = tempData.Limit(pagination);</div></pre></td></tr></table></figure>
<p>如果，表连接或条件较复杂，推荐直接写视图，通过操作视图得到数据。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://mungyulin.github.io/2017/02/12/2017-02-12-SiteMap站点文件/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Mandag">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/icon.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Mandag's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/02/12/2017-02-12-SiteMap站点文件/" itemprop="url">
                  【NET】生成SiteMap网站地图
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-02-12T12:44:00+08:00">
                2017-02-12
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>之前没有用过sitemap，最近做项目接触到sitemap，做下记录</p>
<p>生成如下XML格式文件<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</div><div class="line">&lt;urlset&gt;</div><div class="line">  &lt;url&gt;</div><div class="line">    &lt;loc&gt;URL地址&lt;/loc&gt;</div><div class="line">    &lt;lastmod&gt;最新修改日期&lt;/lastmod&gt;</div><div class="line">    &lt;changefreq&gt;更新频率&lt;/changefreq&gt;</div><div class="line">    &lt;priority&gt;权重&lt;/priority&gt;</div><div class="line">  &lt;/url&gt;</div><div class="line">&lt;/urlset&gt;</div></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div></pre></td><td class="code"><pre><div class="line">/// &lt;summary&gt;</div><div class="line">/// 初始化站点列表</div><div class="line">/// &lt;/summary&gt;</div><div class="line">/// &lt;param name=&quot;list&quot;&gt;&lt;/param&gt;</div><div class="line">public static void CreateSiteXml(Dictionary&lt;Guid, string&gt; list)</div><div class="line">&#123;</div><div class="line">    XmlDocument doc = null;</div><div class="line">    XmlElement root = null;</div><div class="line">    int allCount = list.Count;</div><div class="line">    // 网址不得超过 5 万个，且文件大小不得超过 10 MB</div><div class="line">    const int siteCountFile = 30000;</div><div class="line">    int createMod = allCount / siteCountFile + (allCount % siteCountFile &gt; 0 ? 1 : 0);</div><div class="line"></div><div class="line">    // 循环创建XML</div><div class="line">    for (int i = 1; i &lt;= createMod; i++)</div><div class="line">    &#123;</div><div class="line">        doc = new XmlDocument();</div><div class="line">        XmlDeclaration dec = doc.CreateXmlDeclaration(&quot;1.0&quot;, &quot;utf-8&quot;, null);</div><div class="line">        doc.AppendChild(dec);</div><div class="line">        root = doc.CreateElement(&quot;urlset&quot;);</div><div class="line"></div><div class="line">        int currMod = 0;</div><div class="line"></div><div class="line">        // 循环添加URL</div><div class="line">        foreach (var item in list.Skip((i - 1) * siteCountFile))</div><div class="line">        &#123;</div><div class="line">            if (currMod &lt; siteCountFile)</div><div class="line">            &#123;</div><div class="line">                // 链接地址,长度不得超过256字节</div><div class="line">                XmlElement url = doc.CreateElement(&quot;url&quot;);</div><div class="line">                XmlElement url_loc = doc.CreateElement(&quot;loc&quot;);</div><div class="line">                url_loc.InnerText = item.Value.ToLower();</div><div class="line">                url.AppendChild(url_loc);</div><div class="line"></div><div class="line">                // 链接的最后更新时间</div><div class="line">                XmlElement url_lastmod = doc.CreateElement(&quot;lastmod&quot;);</div><div class="line">                url_lastmod.InnerText = DateTime.Now.ToString(&quot;yyyy-MM-dd&quot;);</div><div class="line">                url.AppendChild(url_lastmod);</div><div class="line"></div><div class="line">                // 链接可能会出现的更新频率</div><div class="line">                XmlElement url_changefreq = doc.CreateElement(&quot;changefreq&quot;);</div><div class="line">                url_changefreq.InnerText = &quot;daily&quot;;</div><div class="line">                url.AppendChild(url_changefreq);</div><div class="line"></div><div class="line">                // 链接的优先权比值，此值定于0.0-1.0之间</div><div class="line">                XmlElement url_priority = doc.CreateElement(&quot;priority&quot;);</div><div class="line">                url_priority.InnerText = &quot;0.8&quot;;</div><div class="line">                url.AppendChild(url_priority);</div><div class="line"></div><div class="line">                root.AppendChild(url);</div><div class="line"></div><div class="line">            &#125;</div><div class="line">            currMod++;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        doc.AppendChild(root);</div><div class="line"></div><div class="line">        // 保存XML</div><div class="line">        string SiteMapDir = System.Web.HttpContext.Current.Server.MapPath(&quot;/SiteMap/sitemap&quot;);</div><div class="line">        string fullFileName = SiteMapDir + string.Format(&quot;&#123;0:d5&#125;&quot;, i) + &quot;.xml&quot;;</div><div class="line">        doc.Save(fullFileName);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">/// &lt;summary&gt;</div><div class="line">/// 插入</div><div class="line">/// &lt;/summary&gt;</div><div class="line">/// &lt;param name=&quot;str&quot;&gt;&lt;/param&gt;</div><div class="line">public static void InsertSiteXml(string str)</div><div class="line">&#123;</div><div class="line">    if (string.IsNullOrWhiteSpace(str))</div><div class="line">        return;</div><div class="line">    const int siteCountFile = 30000;</div><div class="line">    string SiteMapDir = System.Web.HttpContext.Current.Server.MapPath(&quot;/SiteMap/&quot;);</div><div class="line">    string[] file = Directory.GetFiles(SiteMapDir);</div><div class="line">    for (int i = 1; i &lt; file.Length; i++)</div><div class="line">    &#123;</div><div class="line">        XmlDocument xml = new XmlDocument();</div><div class="line">        try</div><div class="line">        &#123;</div><div class="line">            xml.Load(file[i]);</div><div class="line">        &#125;</div><div class="line">        catch (Exception ex)</div><div class="line">        &#123;</div><div class="line">            throw new Exception(ex.Message);</div><div class="line">        &#125;</div><div class="line">        XmlNodeList xmlNodes = xml.SelectNodes(&quot;/urlset/url&quot;);</div><div class="line">        if (xmlNodes.Count &lt; siteCountFile)</div><div class="line">        &#123;</div><div class="line">            XmlNode _root = xml.SelectSingleNode(&quot;/urlset&quot;);</div><div class="line">            XmlNode _url = xml.CreateElement(&quot;url&quot;);</div><div class="line">            XmlNode _url_loc = xml.CreateElement(&quot;loc&quot;);</div><div class="line">            _url_loc.InnerText = str.Trim().ToLower();</div><div class="line">            _url.AppendChild(_url_loc);</div><div class="line">            _root.AppendChild(_url);</div><div class="line">            xml.Save(file[i]);</div><div class="line">            return;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    XmlDocument doc = new XmlDocument();</div><div class="line">    XmlDeclaration dec = doc.CreateXmlDeclaration(&quot;1.0&quot;, &quot;utf-8&quot;, null);</div><div class="line">    doc.AppendChild(dec);</div><div class="line">    XmlElement root = doc.CreateElement(&quot;urlset&quot;);</div><div class="line"></div><div class="line">    XmlElement url = doc.CreateElement(&quot;url&quot;);</div><div class="line">    XmlElement url_loc = doc.CreateElement(&quot;loc&quot;);</div><div class="line">    url_loc.InnerText = str.Trim().ToLower();</div><div class="line">    url.AppendChild(url_loc);</div><div class="line"></div><div class="line">    root.AppendChild(url);</div><div class="line">    doc.AppendChild(root);</div><div class="line">    // 保存XML</div><div class="line">    string fullFileName = SiteMapDir + string.Format(&quot;sitemap&#123;0:d5&#125;&quot;, file.Count()) + &quot;.xml&quot;;</div><div class="line">    doc.Save(fullFileName);</div><div class="line">&#125;</div><div class="line"></div><div class="line">/// &lt;summary&gt;</div><div class="line">/// 删除</div><div class="line">/// &lt;/summary&gt;</div><div class="line">/// &lt;param name=&quot;str&quot;&gt;&lt;/param&gt;</div><div class="line">public static void DeleteSiteXml(string str)</div><div class="line">&#123;</div><div class="line">    if (string.IsNullOrWhiteSpace(str))</div><div class="line">        return;</div><div class="line">    string SiteMapDir = System.Web.HttpContext.Current.Server.MapPath(&quot;/SiteMap/&quot;);</div><div class="line">    string[] file = Directory.GetFiles(SiteMapDir);</div><div class="line">    for (int i = 0; i &lt; file.Length; i++)</div><div class="line">    &#123;</div><div class="line">        XmlDocument xml = new XmlDocument();</div><div class="line">        try</div><div class="line">        &#123;</div><div class="line">            xml.Load(file[i]);</div><div class="line">        &#125;</div><div class="line">        catch (Exception ex)</div><div class="line">        &#123;</div><div class="line">            throw new Exception(ex.Message);</div><div class="line">        &#125;</div><div class="line">        XmlNodeList xmlNodes = xml.SelectNodes(&quot;/urlset/url&quot;);</div><div class="line">        for (int k = 0; k &lt; xmlNodes.Count; k++)</div><div class="line">        &#123;</div><div class="line">            XmlNode node = xmlNodes[k];</div><div class="line">            string text = node.FirstChild.InnerText;</div><div class="line">            if (text.Equals(str.Trim(), StringComparison.OrdinalIgnoreCase))</div><div class="line">            &#123;</div><div class="line">                XmlNode _root = xml.SelectSingleNode(&quot;/urlset&quot;);</div><div class="line">                _root.RemoveChild(node);</div><div class="line">                xml.Save(file[i]);</div><div class="line">                return;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://mungyulin.github.io/2016/12/12/2016-12-12-使用结巴分词检索/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Mandag">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/icon.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Mandag's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/12/12/2016-12-12-使用结巴分词检索/" itemprop="url">
                  【NET】使用结巴分词检索
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2016-12-12T19:22:00+08:00">
                2016-12-12
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>结巴分词的源码：<a href="https://github.com/anderscui/jieba.NET/" target="_blank" rel="external">jieba中文分词</a></p>
<p>在一個检索系统中，使用了结巴分词来进行分词检索，感觉很方便。</p>
<p>首先，把结巴分词的词库写入到数据库中，用来判断检索的关键字是否为新词，<br>如果新词的话，就直接like整篇文章，再保存检索关键字到词库和分词表中；<br>不是的话，就在分词表中进行搜索，这样检索速度就增加了，也不会出现检索不到词的问题。</p>
<p>接在修改结巴分词的源码</p>
<p>修改加载词库的方法：WordDictionary.cs中LoadDict的方法</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">LoadDict</span>(<span class="params"></span>)</span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">try</span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">var</span> stopWatch = <span class="keyword">new</span> Stopwatch();</div><div class="line">        stopWatch.Start();</div><div class="line"></div><div class="line">        <span class="comment">// 从SQL中读取数据</span></div><div class="line">        DBEntities db = <span class="keyword">new</span> DBEntities();</div><div class="line">        <span class="keyword">var</span> dt = db.ThesaurusList().ToList();</div><div class="line">        <span class="keyword">if</span> (dt != <span class="literal">null</span> &amp;&amp; dt.Any())</div><div class="line">        &#123;</div><div class="line">            <span class="keyword">foreach</span> (<span class="keyword">var</span> item <span class="keyword">in</span> dt)</div><div class="line">            &#123;</div><div class="line">                <span class="keyword">var</span> word = e.Convert.ToString(item.Text);</div><div class="line">                <span class="keyword">int</span> freq = <span class="number">0</span>;</div><div class="line">                <span class="keyword">if</span> (item.Frequency.HasValue)</div><div class="line">                    freq = item.Frequency.Value;</div><div class="line"></div><div class="line">                Trie[word] = freq;</div><div class="line">                Total += freq;</div><div class="line"></div><div class="line">                <span class="keyword">foreach</span> (<span class="keyword">var</span> ch <span class="keyword">in</span> Enumerable.Range(<span class="number">0</span>, word.Length))</div><div class="line">                &#123;</div><div class="line">                    <span class="keyword">var</span> wfrag = word.Sub(<span class="number">0</span>, ch + <span class="number">1</span>);</div><div class="line">                    <span class="keyword">if</span> (!Trie.ContainsKey(wfrag))</div><div class="line">                    &#123;</div><div class="line">                        Trie[wfrag] = <span class="number">0</span>;</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        stopWatch.Stop();</div><div class="line">        Debug.WriteLine(<span class="string">"main dict load finished, time elapsed &#123;0&#125; ms"</span>, stopWatch.ElapsedMilliseconds);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">catch</span> (IOException e)</div><div class="line">    &#123;</div><div class="line">        Debug.Fail(<span class="keyword">string</span>.Format(<span class="string">"&#123;0&#125; load failure, reason: &#123;1&#125;"</span>, MainDict, e.Message));</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">catch</span> (FormatException fe)</div><div class="line">    &#123;</div><div class="line">        Debug.Fail(fe.Message);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>增加添加新词的方法</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">SqlDtAdd</span>(<span class="params"><span class="keyword">string</span> word, <span class="keyword">int</span> freq, <span class="keyword">string</span> tag = <span class="literal">null</span></span>)</span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">if</span> (!ContainsWord(word))</div><div class="line">    &#123;</div><div class="line">        DBEntities db = <span class="keyword">new</span> DBEntities();</div><div class="line">        db.ThesaurusAdd(word, tag, freq);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>增加接口调用的方法：在JiebaSegmenter.cs中增加以下两个方法，用于判断分词是否存在并添加新词</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">SqlDtAdd</span>(<span class="params"><span class="keyword">string</span> word, <span class="keyword">int</span> freq = <span class="number">0</span>, <span class="keyword">string</span> tag = <span class="literal">null</span></span>)</span></div><div class="line">&#123;</div><div class="line">    WordDict.SqlDtAdd(word, freq, tag);</div><div class="line">    AddWord(word, freq, tag);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">bool</span> <span class="title">SqlDtContainsWord</span>(<span class="params"><span class="keyword">string</span> text</span>)</span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">return</span> WordDict.ContainsWord(text);</div><div class="line">&#125;</div></pre></td></tr></table></figure>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://mungyulin.github.io/2016/12/10/2016-12-10-网站数据爬取(下)/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Mandag">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/icon.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Mandag's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/12/10/2016-12-10-网站数据爬取(下)/" itemprop="url">
                  【NET】网站数据爬取 上
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2016-12-10T19:58:00+08:00">
                2016-12-10
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>接昨天的</p>
<p>采集内容页，要考虑两点，一个是是否需要登录才能浏览，还有一個是有些网站有限制流量的，超过了就看不了<br>所以需要存着网站的cookie和当前采集的次数</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">Dictionary&lt;<span class="keyword">string</span>, <span class="keyword">long</span>&gt; siteTakeCount = <span class="keyword">new</span> Dictionary&lt;<span class="keyword">string</span>, <span class="keyword">long</span>&gt;();</div><div class="line">Dictionary&lt;<span class="keyword">string</span>, System.Net.CookieContainer&gt; siteTakeCookie = <span class="keyword">new</span> Dictionary&lt;<span class="keyword">string</span>, System.Net.CookieContainer&gt;();</div><div class="line"><span class="keyword">var</span> result = DataHandled.GetStayTakeTask();</div><div class="line"><span class="keyword">if</span> (ConfigManager.CollectTasks != <span class="literal">null</span> &amp;&amp; ConfigManager.CollectTasks.Any())</div><div class="line">&#123;</div><div class="line">    <span class="keyword">foreach</span> (<span class="keyword">var</span> item <span class="keyword">in</span> ConfigManager.CollectTasks)</div><div class="line">    &#123;</div><div class="line">        <span class="keyword">long</span> count = item.PageContent.CollectCountMax &gt; <span class="number">0</span> ? item.PageContent.CollectCountMax : <span class="number">-1</span>;</div><div class="line">        siteTakeCount.Add(item.TaskName, count);</div><div class="line">        siteTakeCookie.Add(item.TaskName, <span class="literal">null</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>初始化采集次数和cookie后，内容页就简单了，</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">string</span> enc = task.PageContent.PageEncode;</div><div class="line"><span class="keyword">if</span> (<span class="keyword">string</span>.IsNullOrWhiteSpace(enc))</div><div class="line">    enc = task.DefaultEncode;</div><div class="line"><span class="keyword">if</span> (task.HasCookie &amp;&amp; siteTakeCookie[task.TaskName] == <span class="literal">null</span>)</div><div class="line">    siteTakeCookie[task.TaskName] = RequestManager.GetCooKie(task.CheckLogin.LoginUrl, task.CheckLogin.LoginData);</div><div class="line"><span class="keyword">var</span> content = RequestManager.GetPage(item.Location, enc, siteTakeCookie[task.TaskName]);</div><div class="line"><span class="keyword">if</span> (!<span class="keyword">string</span>.IsNullOrWhiteSpace(content))</div><div class="line">&#123;</div><div class="line">    <span class="keyword">bool</span> flag = <span class="literal">true</span>;</div><div class="line">    <span class="keyword">if</span> (task.HasCookie &amp;&amp; content.IndexOf(task.CheckLogin.LoginMark) &lt; <span class="number">0</span>)</div><div class="line">    &#123;</div><div class="line">        flag = <span class="literal">false</span>;</div><div class="line">        siteTakeCount[task.TaskName] = <span class="number">0</span>;</div><div class="line">        <span class="keyword">continue</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (task.PageContent.IsSaveAsFile)</div><div class="line">    &#123;</div><div class="line">        <span class="comment">// 保存到本地</span></div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (task.PageContent.IsSaveDataBase)</div><div class="line">    &#123;</div><div class="line">        <span class="comment">// 写入数据库</span></div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (flag)</div><div class="line">    &#123;</div><div class="line">        <span class="comment">// 更新状态，显示已采集</span></div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="keyword">else</span></div><div class="line">&#123;</div><div class="line">    SetLogInfo(<span class="keyword">string</span>.Format(<span class="string">"【&#123;0&#125;】-【&#123;1&#125;】无法获取到页面内容，地址：&#123;2&#125;"</span>, item.TaskName, item.Title, item.Location), LogType.Logger, LogLevelType.Error);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这样子就ok了，再写两个线程，一个用来采集站点，一个用来下载页面信息</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">takeTaskThread = <span class="keyword">new</span> Thread(<span class="keyword">new</span> ThreadStart(GetStayUrlList));</div><div class="line">takeTaskThread.IsBackground = <span class="literal">true</span>;</div><div class="line">takeTaskThread.Name = <span class="string">"采集地址线程"</span>;</div><div class="line">takeTaskThread.Priority = ThreadPriority.Normal;</div><div class="line">takeTaskThread.Start();</div><div class="line"></div><div class="line">takeSaveThread = <span class="keyword">new</span> Thread(<span class="keyword">new</span> ThreadStart(GetStayPageList));</div><div class="line">takeSaveThread.IsBackground = <span class="literal">true</span>;</div><div class="line">takeSaveThread.Name = <span class="string">"下载页面线程"</span>;</div><div class="line">takeSaveThread.Priority = ThreadPriority.BelowNormal;</div><div class="line">takeSaveThread.Start();</div></pre></td></tr></table></figure>
<p>程序运行之后，因为配置文件或其他问题，主界面会出現挂掉的问题，<br>这个时候就需要在程序运行前，检查下一些配置文件等，</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">bool</span> <span class="title">InitFormProgramRunStatus</span>(<span class="params"></span>)</span></div><div class="line">&#123;</div><div class="line">    SetLogInfo(<span class="string">"正在扫描程序配置情况，请稍等~"</span>, LogType.Logger, LogLevelType.Debug);</div><div class="line"></div><div class="line">    <span class="comment">// 数据库配置情况</span></div><div class="line">    <span class="keyword">if</span> (!DataHandled.ConnectionTest())</div><div class="line">    &#123;</div><div class="line">        SetLogInfo(<span class="string">"数据库连接不正确，请先设置数据连接！"</span>, LogType.Logger, LogLevelType.Fatal);</div><div class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// 采集文件配置情况</span></div><div class="line">    <span class="keyword">if</span> (<span class="keyword">string</span>.IsNullOrWhiteSpace(ConfigManager.TaskConfigPath))</div><div class="line">    &#123;</div><div class="line">        SetLogInfo(<span class="string">"采集站点配置文件路径错误！"</span>, LogType.Logger, LogLevelType.Fatal);</div><div class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">string</span>[] files = System.IO.Directory.GetFiles(ConfigManager.TaskConfigPath, <span class="string">"*.xml"</span>);</div><div class="line">    <span class="keyword">if</span> (files.Count() &lt;= <span class="number">0x0</span>)</div><div class="line">    &#123;</div><div class="line">        SetLogInfo(<span class="string">"未找到采集站点配置文件！"</span>, LogType.Logger, LogLevelType.Fatal);</div><div class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    ConfigManager.CollectTasks = <span class="keyword">new</span> List&lt;Task&gt;();</div><div class="line">    <span class="keyword">string</span> errFile = <span class="keyword">string</span>.Empty;</div><div class="line">    <span class="keyword">try</span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">foreach</span> (<span class="keyword">string</span> file <span class="keyword">in</span> files)</div><div class="line">        &#123;</div><div class="line">            errFile = file;</div><div class="line">            Task t = XmlHelper.XmlDeserializeFromFile&lt;Task&gt;(file, Encoding.UTF8);</div><div class="line">            ConfigManager.CollectTasks.Add(t);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">catch</span> (Exception ex)</div><div class="line">    &#123;</div><div class="line">        SetLogInfo(<span class="keyword">string</span>.Format(<span class="string">"采集站点的配置文件序列化失败！错误文件：&#123;0&#125;，错误代码：&#123;1&#125;"</span>, errFile, ex.Message), LogType.Logger, LogLevelType.Fatal);</div><div class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// 下载文件配置情况</span></div><div class="line">    <span class="keyword">try</span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">if</span> (<span class="keyword">string</span>.IsNullOrWhiteSpace(ConfigManager.SaveFilePath()) || !System.IO.Directory.Exists(ConfigManager.SaveFilePath()))</div><div class="line">        &#123;</div><div class="line">            SetLogInfo(<span class="string">"文件保存路径未找到，或路径配置错误！"</span>, LogType.Logger, LogLevelType.Fatal);</div><div class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">catch</span> (Exception ex)</div><div class="line">    &#123;</div><div class="line">        SetLogInfo(<span class="string">"文件保存路径未找到，或路径配置错误！"</span>, LogType.Logger, LogLevelType.Fatal);</div><div class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    SetLogInfo(<span class="string">"扫描成功~"</span>, LogType.Logger, LogLevelType.Debug);</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://mungyulin.github.io/2016/12/09/2016-12-9-网站数据爬取(上)/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Mandag">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/icon.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Mandag's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/12/09/2016-12-9-网站数据爬取(上)/" itemprop="url">
                  【NET】网站数据爬取 上
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2016-12-09T21:30:00+08:00">
                2016-12-09
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>最近因为工作需要，写了个采集网站数据的小程序。<br>主要功能是首先采集网站列表頁的链接存入数据库（需要排除重复采集的可能），第一次，采集全部，之后只采集最新数据，接着，获取采集到的链接地址，保存页面信息。</p>
<p>程序的主要爬取的数据有两部分，一个是列表的链接，一个是内容页的内容</p>
<p>首先采集网站不可避免的会用到正则表达式，所以就需要在XML中配置每个站点的相关采集信息和正则匹配内容等<br>XML模板文件如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</div><div class="line">&lt;Task&gt;</div><div class="line">    &lt;!-- 任务名称 --&gt;</div><div class="line">    &lt;TaskName&gt;Mandag&apos;s Blog&lt;/TaskName&gt;</div><div class="line">    &lt;!-- 任务网站 --&gt;</div><div class="line">    &lt;TaskHost&gt;http://mungyulin.github.io/&lt;/TaskHost&gt;</div><div class="line">    &lt;!-- 采集模式 列表(LIST)或逐页(PAGE) --&gt;</div><div class="line">    &lt;!-- 列表对应PageList --&gt;</div><div class="line">    &lt;!-- 逐页对应StartUrl --&gt;</div><div class="line">    &lt;CollectModel&gt;LIST&lt;/CollectModel&gt;</div><div class="line">    &lt;!-- 列表页面编码 --&gt;</div><div class="line">    &lt;DefaultEncode&gt;utf-8&lt;/DefaultEncode&gt;</div><div class="line">    &lt;!-- 请求方式 POST和GET --&gt;</div><div class="line">    &lt;RequestMethod&gt;POST&lt;/RequestMethod&gt;</div><div class="line">    &lt;!-- 是否需要登录 --&gt;</div><div class="line">    &lt;HasCookie&gt;false&lt;/HasCookie&gt;</div><div class="line">    &lt;ListPage&gt;</div><div class="line">        &lt;!-- 提取分页的总记录(Groups[&quot;totalRecord&quot;])和总页数(Groups[&quot;totalPage&quot;]) --&gt;</div><div class="line">        &lt;TotalPageRegex&gt;&lt;/TotalPageRegex&gt;</div><div class="line">        &lt;!-- 计算分页的标识 记录计算(Record)和分页获取(Page) --&gt;</div><div class="line">        &lt;TotalPageMark&gt;Record&lt;/TotalPageMark&gt;</div><div class="line">        &lt;!-- 分页数据结果匹配正则 --&gt;</div><div class="line">        &lt;ContentResultRegex&gt;&lt;/ContentResultRegex&gt;</div><div class="line">        &lt;!-- 提取采集链接(Groups[&quot;url&quot;])和标题(Groups[&quot;text&quot;]) --&gt;</div><div class="line">        &lt;ListPageUrlRegex&gt;&lt;/ListPageUrlRegex&gt;</div><div class="line">    &lt;/ListPage&gt;</div><div class="line">    &lt;CheckLogin&gt;</div><div class="line">        &lt;!-- 登陆页地址 --&gt;</div><div class="line">        &lt;LoginUrl&gt;&lt;/LoginUrl&gt;</div><div class="line">        &lt;!-- 登陆账户提交表单 --&gt;</div><div class="line">        &lt;LoginData&gt;&lt;/LoginData&gt;</div><div class="line">        &lt;!-- 登陆成功，采集内容的标识 --&gt;</div><div class="line">        &lt;LoginMark&gt;&lt;/LoginMark&gt;</div><div class="line">    &lt;/CheckLogin&gt;</div><div class="line">    &lt;PageContent&gt;</div><div class="line">        &lt;!-- 内容页面编码 --&gt;</div><div class="line">        &lt;PageEncode&gt;utf-8&lt;/PageEncode&gt;</div><div class="line">        &lt;!-- 每次采集上限 大于0时，超过次数，自动停止 --&gt;</div><div class="line">        &lt;CollectCountMax&gt;0&lt;/CollectCountMax&gt;</div><div class="line">        &lt;!-- 是否保存为文件 --&gt;</div><div class="line">        &lt;IsSaveAsFile&gt;true&lt;/IsSaveAsFile&gt;</div><div class="line">        &lt;!-- 是否保存到数据库 --&gt;</div><div class="line">        &lt;IsSaveDataBase&gt;true&lt;/IsSaveDataBase&gt;</div><div class="line">        &lt;!-- 页面标题正则 --&gt;</div><div class="line">        &lt;PageTitleRegex&gt;&lt;/PageTitleRegex&gt;</div><div class="line">        &lt;!-- 页面内容正则 --&gt;</div><div class="line">        &lt;PageContentRegex&gt;&lt;/PageContentRegex&gt;</div><div class="line">        &lt;!-- 页面其他信息正则 --&gt;</div><div class="line">        &lt;PageInfoRegex&gt;&lt;/PageInfoRegex&gt;</div><div class="line">    &lt;/PageContent&gt;</div><div class="line">    &lt;Item&gt;</div><div class="line">        &lt;Title&gt;某某分類&lt;/Title&gt;</div><div class="line">        &lt;!-- 是否跳过采集 --&gt;</div><div class="line">        &lt;NotCollect&gt;false&lt;/NotCollect&gt;</div><div class="line">        &lt;!-- 重置采集 --&gt;</div><div class="line">        &lt;ResetCollect&gt;false&lt;/ResetCollect&gt;</div><div class="line">        &lt;!-- 采集地址 --&gt;</div><div class="line">        &lt;Location&gt;&lt;/Location&gt;</div><div class="line">        &lt;!-- 列表地址 --&gt;</div><div class="line">        &lt;PageList&gt;http://mungyulin.github.io/archive?&#123;limit&#125;&amp;amp;&#123;currentPage&#125;&lt;/PageList&gt;</div><div class="line">        &lt;!-- 地址参数 --&gt;</div><div class="line">        &lt;Parameters limit=&apos;100&apos; currentPage=&apos;1&apos; /&gt;</div><div class="line">        &lt;!-- 表单数据 --&gt;</div><div class="line">        &lt;FormDate&gt;&lt;/FormDate&gt;</div><div class="line">    &lt;/Item&gt;</div><div class="line">&lt;/Task&gt;</div></pre></td></tr></table></figure>
<p>配置文件搞定后，就是解析列表页的链接，把每一页的链接取出來，<br>读取一个配置文件，获取需要采集的站点信息，<br>首先是获取这个站点列表页的初始页面，可以得到总记录数和总页数</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">string</span> page = <span class="keyword">string</span>.Empty;</div><div class="line">Regex regex = <span class="literal">null</span>;</div><div class="line"><span class="keyword">if</span> (!<span class="keyword">string</span>.IsNullOrWhiteSpace(linkItem.ListPage.TotalPageRegex))</div><div class="line">    regex = <span class="keyword">new</span> Regex(linkItem.ListPage.TotalPageRegex, RegexOptions.IgnoreCase | RegexOptions.Singleline | RegexOptions.IgnorePatternWhitespace);</div><div class="line"><span class="keyword">if</span> (linkItem.CollectModel.Equals(<span class="string">"List"</span>, StringComparison.OrdinalIgnoreCase))</div><div class="line">&#123;</div><div class="line">    <span class="comment">// 地址栏带起始记录数进行获取列表数据</span></div><div class="line">    <span class="keyword">if</span> (linkItem.ListPage.TotalPageMark.Equals(<span class="string">"Record"</span>, StringComparison.OrdinalIgnoreCase))</div><div class="line">    &#123;</div><div class="line">        <span class="keyword">if</span> (linkItem.RequestMethod.Equals(<span class="string">"Post"</span>, StringComparison.OrdinalIgnoreCase))</div><div class="line">            page = RequestManager.RequestData(ParaFormat(item.PageList, item.Parameters), item.FormDate, linkItem.DefaultEncode);</div><div class="line">        <span class="keyword">else</span></div><div class="line">            page = RequestManager.GetPage(ParaFormat(item.PageList, item.Parameters), linkItem.DefaultEncode);</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// 地址栏带页数进行获取列表数据</span></div><div class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (linkItem.ListPage.TotalPageMark.Equals(<span class="string">"Page"</span>, StringComparison.OrdinalIgnoreCase))</div><div class="line">    &#123;</div><div class="line">        <span class="keyword">if</span> (linkItem.RequestMethod.Equals(<span class="string">"Post"</span>, StringComparison.OrdinalIgnoreCase))</div><div class="line">            page = RequestManager.RequestData(ParaFormat(item.PageList, item.Parameters), item.FormDate, linkItem.DefaultEncode);</div><div class="line">        <span class="keyword">else</span></div><div class="line">            page = RequestManager.GetPage(ParaFormat(item.PageList, item.Parameters), linkItem.DefaultEncode);</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// 使用表单提交获取列表数据</span></div><div class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (linkItem.ListPage.TotalPageMark.Equals(<span class="string">"Form"</span>, StringComparison.OrdinalIgnoreCase))</div><div class="line">    &#123;</div><div class="line">        <span class="keyword">if</span> (linkItem.RequestMethod.Equals(<span class="string">"Post"</span>, StringComparison.OrdinalIgnoreCase))</div><div class="line">            page = RequestManager.RequestData(item.PageList, ParaFormat(item.FormDate, item.Parameters), linkItem.DefaultEncode);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>得到了总记录数和总页数后，就可以模拟翻页，获取列表链接了，<br>目前网络上的网站列表显示有两种（我只知道两种，不知道的我就不管了╮(╯_╰)╭ ）<br>一种是静态生成，就是一个页面就是一个HTML文件<br>还有一种是动态的，比如通过AJAX获取部分数据并刷新局部页面</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 静态页面 只需考虑页面有列表的情况，沒列表就可以跳出來了</span></div><div class="line"><span class="keyword">string</span> location = item.Location;</div><div class="line"><span class="keyword">int</span> isCount = <span class="number">1</span>;</div><div class="line"><span class="keyword">while</span> (isCount != <span class="number">0</span>)</div><div class="line">&#123;</div><div class="line">    page = RequestManager.GetPage(location, linkItem.DefaultEncode);</div><div class="line">    <span class="keyword">string</span> text = <span class="keyword">string</span>.Empty;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (<span class="keyword">string</span>.IsNullOrWhiteSpace(page))</div><div class="line">    &#123;</div><div class="line">        isCount = <span class="number">0</span>;</div><div class="line">        <span class="keyword">break</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (!<span class="keyword">string</span>.IsNullOrWhiteSpace(linkItem.ListPage.ContentResultRegex))</div><div class="line">    &#123;</div><div class="line">        <span class="keyword">var</span> pageRegex = <span class="keyword">new</span> Regex(linkItem.ListPage.ContentResultRegex, RegexOptions.IgnoreCase | RegexOptions.Singleline | RegexOptions.IgnorePatternWhitespace);</div><div class="line">        Match pageMatch = pageRegex.Match(page);</div><div class="line"></div><div class="line">        text = pageMatch.Value;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    SetLogInfo(<span class="keyword">string</span>.Format(<span class="string">"正在采集【&#123;0&#125;】-【&#123;1&#125;】 &#123;2&#125;"</span>, linkItem.TaskName, item.Title, location), LogType.StayTakeSite);</div><div class="line"></div><div class="line">    <span class="keyword">var</span> list = UrlManager.UrlParse(text, item.Location, linkItem.ListPage.ListPageUrlRegex);</div><div class="line">    <span class="keyword">if</span> (list != <span class="literal">null</span> &amp;&amp; list.Any())</div><div class="line">    &#123;</div><div class="line">        <span class="keyword">foreach</span> (<span class="keyword">var</span> url <span class="keyword">in</span> list)</div><div class="line">        &#123;</div><div class="line">            <span class="comment">// 这里添加到数据库</span></div><div class="line">        &#125;</div><div class="line">        location = <span class="keyword">string</span>.Format(item.StartUrl, isCount);</div><div class="line">        isCount++;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">else</span></div><div class="line">        isCount = <span class="number">0</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 动态页面 一定要有总页数</span></div><div class="line">page = page.Replace(<span class="string">"&amp;nbsp;"</span>, <span class="string">" "</span>);</div><div class="line">Match match = regex.Match(page);</div><div class="line"><span class="keyword">if</span> (match.Groups[<span class="string">"totalRecord"</span>].Success)</div><div class="line">&#123;</div><div class="line">    item.Parameters.TotalRecord = e.Convert.ToInt(match.Groups[<span class="string">"totalRecord"</span>].Value);</div><div class="line">&#125;</div><div class="line"><span class="keyword">if</span> (match.Groups[<span class="string">"totalPage"</span>].Success)</div><div class="line">&#123;</div><div class="line">    item.Parameters.TotalPage = e.Convert.ToInt(match.Groups[<span class="string">"totalPage"</span>].Value);</div><div class="line">&#125;</div><div class="line"><span class="keyword">if</span>(match.Groups[<span class="string">"totalRecord"</span>].Success &amp;&amp; !match.Groups[<span class="string">"totalPage"</span>].Success)</div><div class="line">&#123;</div><div class="line">    <span class="comment">// 计算总页数</span></div><div class="line">    <span class="keyword">if</span> (item.Parameters.Limit != <span class="number">0x0</span>)</div><div class="line">    &#123;</div><div class="line">        item.Parameters.TotalPage = item.Parameters.TotalRecord / item.Parameters.Limit;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">else</span></div><div class="line">    &#123;</div><div class="line">        SetLogInfo(<span class="keyword">string</span>.Format(<span class="string">"【&#123;0&#125;】-【&#123;1&#125;】&#123;2&#125;"</span>, linkItem.TaskName, item.Title, <span class="string">"缺少每页数量的值，无法进行处理！"</span>), LogType.Logger, LogLevelType.Error);</div><div class="line">        <span class="keyword">continue</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="comment">// 通过总页数模拟翻页</span></div><div class="line">item.Parameters.CurrentPage = <span class="number">1</span>;</div><div class="line"><span class="keyword">while</span> (item.Parameters.CurrentPage &lt;= item.Parameters.TotalPage)</div><div class="line">&#123;</div><div class="line">    <span class="keyword">string</span> location = <span class="keyword">string</span>.Empty;</div><div class="line">    Regex textRegex = <span class="literal">null</span>;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (!<span class="keyword">string</span>.IsNullOrWhiteSpace(linkItem.ListPage.ContentResultRegex))</div><div class="line">        textRegex = <span class="keyword">new</span> Regex(linkItem.ListPage.ContentResultRegex, RegexOptions.IgnoreCase | RegexOptions.Singleline | RegexOptions.IgnorePatternWhitespace);</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (linkItem.CollectModel.Equals(<span class="string">"List"</span>, StringComparison.OrdinalIgnoreCase))</div><div class="line">    &#123;</div><div class="line">        <span class="keyword">if</span> (linkItem.ListPage.TotalPageMark.Equals(<span class="string">"Record"</span>, StringComparison.OrdinalIgnoreCase))</div><div class="line">        &#123;</div><div class="line">            <span class="comment">// 计算数据的起始记录</span></div><div class="line">            item.Parameters.StartNumber = item.Parameters.Limit * (item.Parameters.CurrentPage - <span class="number">1</span>) + <span class="number">1</span>;</div><div class="line">            item.Parameters.EndNumber = item.Parameters.Limit * item.Parameters.CurrentPage;</div><div class="line">            <span class="keyword">if</span> (item.Parameters.EndNumber &gt; item.Parameters.TotalRecord)</div><div class="line">                item.Parameters.EndNumber = item.Parameters.TotalRecord;</div><div class="line">            location = ParaFormat(item.PageList, item.Parameters);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (linkItem.ListPage.TotalPageMark.Equals(<span class="string">"Page"</span>, StringComparison.OrdinalIgnoreCase))</div><div class="line">        &#123;</div><div class="line">            location = ParaFormat(item.PageList, item.Parameters);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">else</span></div><div class="line">        &#123;</div><div class="line">            location = item.PageList;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (!<span class="keyword">string</span>.IsNullOrWhiteSpace(location))</div><div class="line">    &#123;</div><div class="line">        SetLogInfo(<span class="keyword">string</span>.Format(<span class="string">"正在采集【&#123;0&#125;】-【&#123;1&#125;】共&#123;2&#125;页/第&#123;3&#125;页 &#123;4&#125;"</span>, linkItem.TaskName, item.Title, item.Parameters.TotalPage, item.Parameters.CurrentPage, location), LogType.StayTakeSite);</div><div class="line"></div><div class="line">        <span class="keyword">string</span> text = <span class="keyword">string</span>.Empty;</div><div class="line"></div><div class="line">        <span class="comment">// 配置文件中，未配置表单数据</span></div><div class="line">        <span class="comment">// 该站点则为GET进行获取</span></div><div class="line">        <span class="comment">// 否则为POST提交表单数据进行获取</span></div><div class="line">        <span class="keyword">if</span> (linkItem.RequestMethod.Equals(<span class="string">"Post"</span>, StringComparison.OrdinalIgnoreCase))</div><div class="line">        &#123;</div><div class="line">            <span class="keyword">if</span> (linkItem.ListPage.TotalPageMark.Equals(<span class="string">"Record"</span>, StringComparison.OrdinalIgnoreCase))</div><div class="line">            &#123;</div><div class="line">                text = RequestManager.RequestData(location, item.FormDate, linkItem.DefaultEncode);</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">else</span></div><div class="line">            &#123;</div><div class="line">                text = RequestManager.RequestData(location, ParaFormat(item.FormDate, item.Parameters), linkItem.DefaultEncode);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">else</span></div><div class="line">        &#123;</div><div class="line">            text = RequestManager.GetPage(location, linkItem.DefaultEncode);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (!<span class="keyword">string</span>.IsNullOrWhiteSpace(text))</div><div class="line">        &#123;</div><div class="line">            <span class="comment">// 得到筛选A标签的部分文本内容</span></div><div class="line">            <span class="keyword">if</span> (textRegex != <span class="literal">null</span>)</div><div class="line">            &#123;</div><div class="line">                MatchCollection textMatch = textRegex.Matches(text);</div><div class="line">                text = <span class="keyword">string</span>.Empty;</div><div class="line">                <span class="keyword">foreach</span> (Match mc <span class="keyword">in</span> textMatch)</div><div class="line">                &#123;</div><div class="line">                    text += mc.Value;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="comment">// 得到待采集站点列表</span></div><div class="line">            <span class="keyword">var</span> list = UrlManager.UrlParse(text, item.Location, linkItem.ListPage.ListPageUrlRegex);</div><div class="line">            <span class="keyword">if</span> (list != <span class="literal">null</span> &amp;&amp; list.Any())</div><div class="line">            &#123;</div><div class="line">                <span class="keyword">foreach</span> (<span class="keyword">var</span> url <span class="keyword">in</span> list)</div><div class="line">                &#123;</div><div class="line">                    <span class="comment">//這裏添加到数据库</span></div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">else</span></div><div class="line">            &#123;</div><div class="line">                SetLogInfo(<span class="keyword">string</span>.Format(<span class="string">"【&#123;0&#125;】-【&#123;1&#125;】共&#123;2&#125;页/第&#123;3&#125;页 未提取到a标签！"</span>, linkItem.TaskName, item.Title, item.Parameters.TotalPage, item.Parameters.CurrentPage), LogType.Logger, LogLevelType.Warn);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">else</span></div><div class="line">        &#123;</div><div class="line">            SetLogInfo(<span class="keyword">string</span>.Format(<span class="string">"【&#123;0&#125;】-【&#123;1&#125;】共&#123;2&#125;页/第&#123;3&#125;页 未读取到数据，无法进行数据采集！"</span>, linkItem.TaskName, item.Title, item.Parameters.TotalPage, item.Parameters.CurrentPage), LogType.Logger, LogLevelType.Error);</div><div class="line">            <span class="keyword">continue</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">else</span></div><div class="line">    &#123;</div><div class="line">        SetLogInfo(<span class="keyword">string</span>.Format(<span class="string">"正在采集【&#123;0&#125;】-【&#123;1&#125;】共&#123;2&#125;页/第&#123;3&#125;页 采集地址未定义！"</span>, linkItem.TaskName, item.Title, item.Parameters.TotalPage, item.Parameters.CurrentPage), LogType.Logger, LogLevelType.Warn);</div><div class="line">        <span class="keyword">continue</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (item.Parameters.CurrentPage != <span class="keyword">int</span>.MaxValue)</div><div class="line">        item.Parameters.CurrentPage++;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>地址采集的OK了，内容页的明天贴。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://mungyulin.github.io/2016/07/21/2016-7-21-Python简单数据爬取/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Mandag">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/icon.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Mandag's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/07/21/2016-7-21-Python简单数据爬取/" itemprop="url">
                  【Python】Python简单数据爬取
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2016-07-21T12:36:00+08:00">
                2016-07-21
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>这段时间再看《黑客軍團》，就稍稍的翻了下 <strong>知道创宇研发技能表</strong>，太复杂，不过还是学习了下Python，</p>
<p>恩，并且学习着写了个简单的抓取网站图片的小程序。</p>
<p>爬取的网站是：<a href="http://www.22mm.cc/" target="_blank" rel="external">http://www.22mm.cc/</a><br><br><br>以下使用的是Python2.7版本。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 程序主要入口</span></div><div class="line"><span class="comment">#!/usr/bin/env python</span></div><div class="line"><span class="comment"># -*- coding: utf-8 -*-</span></div><div class="line"></div><div class="line"><span class="keyword">import</span> url_manager, pic_downloader, pic_outputer, pic_parser</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">SpiderMain</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></div><div class="line">        self.urls = url_manager.UrlManager()</div><div class="line">        self.parser = pic_parser.HtmlParser()</div><div class="line">        self.outputer = pic_outputer.HtmlOutputer()</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">getPage</span><span class="params">(self, url)</span>:</span></div><div class="line">        <span class="keyword">if</span> url <span class="keyword">is</span> <span class="keyword">None</span>:</div><div class="line">            <span class="keyword">return</span> <span class="keyword">None</span></div><div class="line">        response = urllib2.urlopen(url)</div><div class="line">        <span class="keyword">if</span> response.getcode() != <span class="number">200</span>:</div><div class="line">            <span class="keyword">return</span> <span class="keyword">None</span></div><div class="line">        <span class="keyword">return</span> response.read()</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">craw</span><span class="params">(self, root_url)</span>:</span></div><div class="line">        self.urls.add_new_url(root_url)</div><div class="line">        <span class="keyword">while</span> self.urls.has_new_url():</div><div class="line">            <span class="keyword">try</span>:</div><div class="line">                new_url = self.urls.get_new_url()</div><div class="line">                html_cont = self.getPage(new_url)</div><div class="line">                new_urls, new_data = self.parser.parse(new_url, html_cont)</div><div class="line">                self.urls.add_new_urls(new_urls)</div><div class="line">                self.outputer.collect_data(new_data)</div><div class="line">            <span class="keyword">except</span>:</div><div class="line">                <span class="keyword">print</span> <span class="string">'craw failed'</span></div><div class="line"></div><div class="line">        self.outputer.output_html()</div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</div><div class="line">    root_url = <span class="string">"http://www.22mm.cc/"</span></div><div class="line">    obj_spider = SpiderMain()</div><div class="line">    obj_spider.craw(root_url)</div></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># Url管理器</span></div><div class="line"><span class="comment">#!/usr/bin/env python2</span></div><div class="line"><span class="comment"># -*- coding: UTF-8 -*-</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">UrlManager</span><span class="params">(object)</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></div><div class="line">        self.new_urls = set()</div><div class="line">        self.old_urls = set()</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">add_new_url</span><span class="params">(self, url)</span>:</span></div><div class="line">        <span class="keyword">if</span> url <span class="keyword">is</span> <span class="keyword">None</span>:</div><div class="line">            <span class="keyword">return</span></div><div class="line">        <span class="keyword">if</span> url <span class="keyword">not</span> <span class="keyword">in</span> self.new_urls <span class="keyword">and</span> url <span class="keyword">not</span> <span class="keyword">in</span> self.old_urls:</div><div class="line">            self.new_urls.add(url)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">add_new_urls</span><span class="params">(self, urls)</span>:</span></div><div class="line">        <span class="keyword">if</span> urls <span class="keyword">is</span> <span class="keyword">None</span> <span class="keyword">or</span> len(urls) == <span class="number">0</span>:</div><div class="line">            <span class="keyword">return</span></div><div class="line">        <span class="keyword">for</span> url <span class="keyword">in</span> urls:</div><div class="line">            self.add_new_url(url)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">has_new_url</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="keyword">return</span> len(self.new_urls) != <span class="number">0</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_new_url</span><span class="params">(self)</span>:</span></div><div class="line">        new_url = self.new_urls.pop()</div><div class="line">        self.old_urls.add(new_url)</div><div class="line">        <span class="keyword">return</span> new_url</div></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># Html解析器</span></div><div class="line"><span class="comment">#!/usr/bin/env python2</span></div><div class="line"><span class="comment"># -*- coding: UTF-8 -*-</span></div><div class="line"></div><div class="line"><span class="keyword">import</span> re, urlparse</div><div class="line"><span class="keyword">from</span> bs4 <span class="keyword">import</span> BeautifulSoup</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">HtmlParser</span><span class="params">(object)</span>:</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">parse</span><span class="params">(self, page_url, html_cont)</span>:</span></div><div class="line">        <span class="keyword">if</span> page_url <span class="keyword">is</span> <span class="keyword">None</span> <span class="keyword">or</span> html_cont <span class="keyword">is</span> <span class="keyword">None</span>:</div><div class="line">            <span class="keyword">return</span></div><div class="line"></div><div class="line">        soup = BeautifulSoup(html_cont, <span class="string">'html.parser'</span>, from_encoding=<span class="string">'utf-8'</span>)</div><div class="line">        new_urls = self._get_new_urls(page_url, soup)</div><div class="line">        new_data = self._get_new_data(page_url, soup)</div><div class="line">        <span class="keyword">return</span> new_urls, new_data</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_get_new_urls</span><span class="params">(self, page_url, soup)</span>:</span></div><div class="line">        new_urls = set()</div><div class="line">        links = soup.find_all(<span class="string">'a'</span>, href = re.compile(<span class="string">r"/mm/(.*?)/(.*?).html"</span>))</div><div class="line">        <span class="keyword">for</span> link <span class="keyword">in</span> links:</div><div class="line">            new_url = link[<span class="string">'href'</span>]</div><div class="line">            new_full_url = new_url</div><div class="line">            <span class="keyword">if</span> <span class="string">"http://"</span> <span class="keyword">not</span> <span class="keyword">in</span> new_url:</div><div class="line">                new_full_url = urlparse.urljoin(page_url, new_url)</div><div class="line">            new_urls.add(new_full_url)</div><div class="line">        <span class="keyword">return</span> new_urls</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_get_new_data</span><span class="params">(self, page_url, soup)</span>:</span></div><div class="line">        res_data = &#123;&#125;</div><div class="line"></div><div class="line">        new_str_url = page_url.replace(<span class="string">'/'</span>,<span class="string">''</span>).replace(<span class="string">'http:'</span>,<span class="string">''</span>).replace(<span class="string">'https:'</span>,<span class="string">''</span>)</div><div class="line">        res_data[<span class="string">'url'</span>] = new_str_url</div><div class="line"></div><div class="line">        res_data[<span class="string">'img'</span>] = &#123;&#125;</div><div class="line">        image_list = soup.find_all(<span class="string">'img'</span>, src = re.compile(<span class="string">r"(.*?)\.jpg"</span>))</div><div class="line">        <span class="keyword">for</span> item <span class="keyword">in</span> image_list:</div><div class="line">            res_data[<span class="string">'img'</span>][item[<span class="string">'src'</span>]] = item[<span class="string">'src'</span>].split(<span class="string">'/'</span>)[<span class="number">-1</span>]</div><div class="line"></div><div class="line">        <span class="keyword">return</span> res_data</div></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># HtmL生成器</span></div><div class="line"><span class="comment">#!/usr/bin/env python2</span></div><div class="line"><span class="comment"># -*- coding: UTF-8 -*-</span></div><div class="line"></div><div class="line"><span class="keyword">import</span> sys, os, urllib</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">HtmlOutputer</span><span class="params">(object)</span>:</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></div><div class="line">        reload(sys)</div><div class="line">        sys.setdefaultencoding(<span class="string">'utf8'</span>)</div><div class="line">        self.datas = []</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">saveImg</span><span class="params">(self, imageURL, fileName)</span>:</span></div><div class="line">        imageData = urllib.urlopen(imageURL).read()</div><div class="line">        f = open(fileName, <span class="string">'wb'</span>)</div><div class="line">        f.write(imageData)</div><div class="line">        <span class="keyword">print</span> <span class="string">u"正在保存图片："</span>, fileName</div><div class="line">        f.close()</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">mkdir</span><span class="params">(self, path)</span>:</span></div><div class="line">        path = path.strip()</div><div class="line">        isExists = os.path.exists(path)</div><div class="line">        <span class="keyword">if</span> <span class="keyword">not</span> isExists:</div><div class="line">            <span class="keyword">print</span> <span class="string">u"新建了"</span>, path, <span class="string">u'文件夹'</span></div><div class="line">            os.makedirs(path)</div><div class="line">            <span class="keyword">return</span> <span class="keyword">True</span></div><div class="line">        <span class="keyword">else</span>:</div><div class="line">            <span class="keyword">print</span> <span class="string">u"名为"</span>, path, <span class="string">'的文件夹已经创建成功'</span></div><div class="line">            <span class="keyword">return</span> <span class="keyword">False</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">collect_data</span><span class="params">(self, data)</span>:</span></div><div class="line">        <span class="keyword">if</span> data <span class="keyword">is</span> <span class="keyword">None</span>:</div><div class="line">            <span class="keyword">return</span></div><div class="line">        self.datas.append(data)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">output_html</span><span class="params">(self)</span>:</span></div><div class="line">        fout = open(<span class="string">'output.html'</span>, <span class="string">'w'</span>)</div><div class="line">        fout.write(<span class="string">"&lt;html&gt;"</span>)</div><div class="line">        fout.write(<span class="string">"&lt;body&gt;"</span>)</div><div class="line">        fout.write(<span class="string">"&lt;table border='1' cellspacing='0' bordercolor='#666666' style='border-collapse: collapse;'&gt;"</span>)</div><div class="line">        fout.write(<span class="string">"&lt;tr&gt;&lt;th&gt;Url&lt;/th&gt;&lt;th&gt;Images&lt;/th&gt;&lt;th&gt;Name&lt;/th&gt;&lt;/tr&gt;"</span>)</div><div class="line">        <span class="keyword">for</span> data <span class="keyword">in</span> self.datas:</div><div class="line">            <span class="keyword">for</span> key, value <span class="keyword">in</span> data[<span class="string">'img'</span>].items():</div><div class="line">                fout.write(<span class="string">"&lt;tr&gt;"</span>)</div><div class="line">                fout.write(<span class="string">"&lt;td&gt;%s&lt;/td&gt;"</span> % data[<span class="string">'url'</span>])</div><div class="line">                fout.write(<span class="string">"&lt;td&gt;"</span>)</div><div class="line">                fout.write(<span class="string">"&lt;img src='%s'&gt;"</span> % key.encode(<span class="string">'utf-8'</span>))</div><div class="line">                fout.write(<span class="string">"&lt;/td&gt;"</span>)</div><div class="line">                fout.write(<span class="string">"&lt;td&gt;%s&lt;/td&gt;"</span> % value.encode(<span class="string">'utf-8'</span>))</div><div class="line">                fout.write(<span class="string">"&lt;/tr&gt;"</span>)</div><div class="line">                self.mkdir(data[<span class="string">'url'</span>])</div><div class="line">                self.saveImg(key, data[<span class="string">'url'</span>] + <span class="string">u"/"</span> + value)</div><div class="line">        fout.write(<span class="string">"&lt;/table&gt;"</span>)</div><div class="line">        fout.write(<span class="string">"&lt;/body&gt;"</span>)</div><div class="line">        fout.write(<span class="string">"&lt;/html&gt;"</span>)</div><div class="line">        fout.close()</div></pre></td></tr></table></figure>
<blockquote>
<p>参考网站：<br><a href="http://www.liaoxuefeng.com/wiki/001374738125095c955c1e6d8bb493182103fac9270762a000" target="_blank" rel="external">Python 2.7教程</a><br><a href="http://wiki.jikexueyuan.com/project/python-crawler-guide/" target="_blank" rel="external">Python 爬虫学习系列教程</a><br><a href="http://www.imooc.com/learn/563" target="_blank" rel="external">Python开发简单爬虫</a></p>
</blockquote>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://mungyulin.github.io/2016/07/06/2016-7-06-JvectorMap使用/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Mandag">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/icon.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Mandag's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/07/06/2016-7-06-JvectorMap使用/" itemprop="url">
                  【JQuery】使用JvectorMap进行足迹设置
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2016-07-06T20:36:00+08:00">
                2016-07-06
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>JvectorMap是一款基于jquery的地图插件，官网是 <a href="http://jvectormap.com/" target="_blank" rel="external">jvectormap.com</a><br><br>下面简单的试用了下这款插件，并用它设置我的足迹信息。<br><img src="/images/20160729180501.png" alt="我的足迹"></p>
<h3 id="首先引用JS文件"><a href="#首先引用JS文件" class="headerlink" title="首先引用JS文件"></a>首先引用JS文件</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 注意引用顺序</span></div><div class="line">&lt;link rel=<span class="string">"stylesheet"</span> type=<span class="string">"text/css"</span> href=<span class="string">"/dist/jquery-jvectormap/jquery-jvectormap-2.0.3.css"</span>&gt;</div><div class="line">&lt;script type="text/javascript" src="/dist/jquery-3.0.0.min.js"&gt;&lt;/script&gt;</div><div class="line">&lt;script type=<span class="string">"text/javascript"</span> src=<span class="string">"/dist/jquery-jvectormap/jquery-jvectormap-2.0.3.min.js"</span>&gt;&lt;/script&gt;</div><div class="line"><span class="comment">// 官网上下载的中国配置文件</span></div><div class="line">&lt;script type=<span class="string">"text/javascript"</span> src=<span class="string">"/dist/jquery-jvectormap/jquery-jvectormap-cn-merc.js"</span>&gt;&lt;/script&gt;</div></pre></td></tr></table></figure>
<h3 id="增加框架"><a href="#增加框架" class="headerlink" title="增加框架"></a>增加框架</h3><figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">style</span> <span class="attr">type</span>=<span class="string">"text/css"</span>&gt;</span><span class="undefined"></span></div><div class="line">    .map-container &#123;</div><div class="line">        width: 800px;</div><div class="line">        height: 600px;</div><div class="line">    &#125;</div><div class="line">    // 隐藏地图左上角 + — 按钮</div><div class="line">    .jvectormap-zoomin,</div><div class="line">    .jvectormap-zoomout &#123;</div><div class="line">        display: none;</div><div class="line">    &#125;</div><div class="line"><span class="tag">&lt;/<span class="name">style</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"maps"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"map-container"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></div></pre></td></tr></table></figure>
<h3 id="调用插件，初始化并设置相关信息"><a href="#调用插件，初始化并设置相关信息" class="headerlink" title="调用插件，初始化并设置相关信息"></a>调用插件，初始化并设置相关信息</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> mapdata = [ <span class="comment">// 使配置文件的地图信息显示中文名称</span></div><div class="line">    &#123; <span class="attr">id</span>: <span class="string">"CN-32"</span>, <span class="attr">province</span>: <span class="string">"江苏"</span>, <span class="attr">data</span>: <span class="string">"Jiangsu"</span> &#125;,</div><div class="line">    &#123; <span class="attr">id</span>: <span class="string">"CN-52"</span>, <span class="attr">province</span>: <span class="string">"贵州"</span>, <span class="attr">data</span>: <span class="string">"Guizhou"</span> &#125;,</div><div class="line">    &#123; <span class="attr">id</span>: <span class="string">"CN-53"</span>, <span class="attr">province</span>: <span class="string">"云南"</span>, <span class="attr">data</span>: <span class="string">"Yunnan"</span> &#125;,</div><div class="line">    &#123; <span class="attr">id</span>: <span class="string">"CN-50"</span>, <span class="attr">province</span>: <span class="string">"重庆"</span>, <span class="attr">data</span>: <span class="string">"Chongqing"</span> &#125;,</div><div class="line">    &#123; <span class="attr">id</span>: <span class="string">"CN-51"</span>, <span class="attr">province</span>: <span class="string">"四川"</span>, <span class="attr">data</span>: <span class="string">"Sichuan"</span> &#125;,</div><div class="line">    &#123; <span class="attr">id</span>: <span class="string">"CN-31"</span>, <span class="attr">province</span>: <span class="string">"上海"</span>, <span class="attr">data</span>: <span class="string">"Shanghai"</span> &#125;,</div><div class="line">    &#123; <span class="attr">id</span>: <span class="string">"CN-54"</span>, <span class="attr">province</span>: <span class="string">"西藏"</span>, <span class="attr">data</span>: <span class="string">"Xizang"</span> &#125;,</div><div class="line">    &#123; <span class="attr">id</span>: <span class="string">"CN-33"</span>, <span class="attr">province</span>: <span class="string">"浙江"</span>, <span class="attr">data</span>: <span class="string">"Zhejiang"</span> &#125;,</div><div class="line">    &#123; <span class="attr">id</span>: <span class="string">"CN-15"</span>, <span class="attr">province</span>: <span class="string">"内蒙古"</span>, <span class="attr">data</span>: <span class="string">"Inner Mongol"</span> &#125;,</div><div class="line">    &#123; <span class="attr">id</span>: <span class="string">"CN-14"</span>, <span class="attr">province</span>: <span class="string">"山西"</span>, <span class="attr">data</span>: <span class="string">"Shanxi"</span> &#125;,</div><div class="line">    &#123; <span class="attr">id</span>: <span class="string">"CN-"</span>, <span class="attr">province</span>: <span class="string">"福建"</span>, <span class="attr">data</span>: <span class="string">"Fujian"</span> &#125;,</div><div class="line">    &#123; <span class="attr">id</span>: <span class="string">"CN-12"</span>, <span class="attr">province</span>: <span class="string">"天津"</span>, <span class="attr">data</span>: <span class="string">"Tianjin"</span> &#125;,</div><div class="line">    &#123; <span class="attr">id</span>: <span class="string">"CN-13"</span>, <span class="attr">province</span>: <span class="string">"河北"</span>, <span class="attr">data</span>: <span class="string">"Hebei"</span> &#125;,</div><div class="line">    &#123; <span class="attr">id</span>: <span class="string">"CN-11"</span>, <span class="attr">province</span>: <span class="string">"北京"</span>, <span class="attr">data</span>: <span class="string">"Beijing"</span> &#125;,</div><div class="line">    &#123; <span class="attr">id</span>: <span class="string">"CN-34"</span>, <span class="attr">province</span>: <span class="string">"安徽"</span>, <span class="attr">data</span>: <span class="string">"Anhui"</span> &#125;,</div><div class="line">    &#123; <span class="attr">id</span>: <span class="string">"CN-36"</span>, <span class="attr">province</span>: <span class="string">"江西"</span>, <span class="attr">data</span>: <span class="string">"Jiangxi"</span> &#125;,</div><div class="line">    &#123; <span class="attr">id</span>: <span class="string">"CN-37"</span>, <span class="attr">province</span>: <span class="string">"山东"</span>, <span class="attr">data</span>: <span class="string">"Shandong"</span> &#125;,</div><div class="line">    &#123; <span class="attr">id</span>: <span class="string">"CN-41"</span>, <span class="attr">province</span>: <span class="string">"河南"</span>, <span class="attr">data</span>: <span class="string">"Henan"</span> &#125;,</div><div class="line">    &#123; <span class="attr">id</span>: <span class="string">"CN-43"</span>, <span class="attr">province</span>: <span class="string">"湖南"</span>, <span class="attr">data</span>: <span class="string">"Hunan"</span> &#125;,</div><div class="line">    &#123; <span class="attr">id</span>: <span class="string">"CN-42"</span>, <span class="attr">province</span>: <span class="string">"湖北"</span>, <span class="attr">data</span>: <span class="string">"Hubei"</span> &#125;,</div><div class="line">    &#123; <span class="attr">id</span>: <span class="string">"CN-45"</span>, <span class="attr">province</span>: <span class="string">"广西"</span>, <span class="attr">data</span>: <span class="string">"Guangxi"</span> &#125;,</div><div class="line">    &#123; <span class="attr">id</span>: <span class="string">"CN-44"</span>, <span class="attr">province</span>: <span class="string">"广东"</span>, <span class="attr">data</span>: <span class="string">"Guangdong"</span> &#125;,</div><div class="line">    &#123; <span class="attr">id</span>: <span class="string">"CN-46"</span>, <span class="attr">province</span>: <span class="string">"海南"</span>, <span class="attr">data</span>: <span class="string">"Hainan"</span> &#125;,</div><div class="line">    &#123; <span class="attr">id</span>: <span class="string">"CN-65"</span>, <span class="attr">province</span>: <span class="string">"新疆"</span>, <span class="attr">data</span>: <span class="string">"Xinjiang"</span> &#125;,</div><div class="line">    &#123; <span class="attr">id</span>: <span class="string">"CN-64"</span>, <span class="attr">province</span>: <span class="string">"宁夏"</span>, <span class="attr">data</span>: <span class="string">"Ningxia"</span> &#125;,</div><div class="line">    &#123; <span class="attr">id</span>: <span class="string">"CN-63"</span>, <span class="attr">province</span>: <span class="string">"青海"</span>, <span class="attr">data</span>: <span class="string">"Qinghai"</span> &#125;,</div><div class="line">    &#123; <span class="attr">id</span>: <span class="string">"CN-62"</span>, <span class="attr">province</span>: <span class="string">"甘肃"</span>, <span class="attr">data</span>: <span class="string">"Gansu"</span> &#125;,</div><div class="line">    &#123; <span class="attr">id</span>: <span class="string">"CN-61"</span>, <span class="attr">province</span>: <span class="string">"山西"</span>, <span class="attr">data</span>: <span class="string">"Shaanxi"</span> &#125;,</div><div class="line">    &#123; <span class="attr">id</span>: <span class="string">"CN-23"</span>, <span class="attr">province</span>: <span class="string">"黑龙江"</span>, <span class="attr">data</span>: <span class="string">"Heilongjiang"</span> &#125;,</div><div class="line">    &#123; <span class="attr">id</span>: <span class="string">"CN-22"</span>, <span class="attr">province</span>: <span class="string">"吉林"</span>, <span class="attr">data</span>: <span class="string">"Jilin"</span> &#125;,</div><div class="line">    &#123; <span class="attr">id</span>: <span class="string">"CN-21"</span>, <span class="attr">province</span>: <span class="string">"辽宁"</span>, <span class="attr">data</span>: <span class="string">"Liaoning"</span> &#125;,</div><div class="line">    &#123; <span class="attr">id</span>: <span class="string">"CN-18"</span>, <span class="attr">province</span>: <span class="string">"台湾"</span>, <span class="attr">data</span>: <span class="string">"Taiwan"</span> &#125;,</div><div class="line">    &#123; <span class="attr">id</span>: <span class="string">"CN-19"</span>, <span class="attr">province</span>: <span class="string">"钓鱼岛"</span>, <span class="attr">data</span>: <span class="string">"DiaoyuIslands"</span> &#125;,</div><div class="line">    &#123; <span class="attr">id</span>: <span class="string">"MAC"</span>, <span class="attr">province</span>: <span class="string">"澳门"</span>, <span class="attr">data</span>: <span class="string">"Macao"</span> &#125;,</div><div class="line">    &#123; <span class="attr">id</span>: <span class="string">"HKG"</span>, <span class="attr">province</span>: <span class="string">"香港"</span>, <span class="attr">data</span>: <span class="string">"Hongkong"</span> &#125;</div><div class="line">],</div><div class="line">markers = [ <span class="comment">// 给地图添加标记</span></div><div class="line">    &#123; <span class="attr">latLng</span>: [<span class="number">29.92</span>, <span class="number">95.75</span>], <span class="attr">name</span>: <span class="string">'西藏 - 波密 2014'</span> &#125;,</div><div class="line">    ...</div><div class="line">],</div><div class="line">names = &#123;&#125;;</div><div class="line">$.each(mapdata, <span class="function"><span class="keyword">function</span> (<span class="params">index, item</span>) </span>&#123;</div><div class="line">    names[item.id] = item.province;</div><div class="line">&#125;);</div><div class="line">$(<span class="string">'.map-container'</span>).vectorMap(&#123;</div><div class="line">    <span class="attr">map</span>: <span class="string">'cn_merc'</span>,</div><div class="line">    <span class="attr">backgroundColor</span>: <span class="string">'#fff'</span>, <span class="comment">// 地图背景色</span></div><div class="line">    zoomAnimate: <span class="literal">false</span>,</div><div class="line">    <span class="attr">zoomOnScroll</span>: <span class="literal">false</span>, <span class="comment">// 是否可以使用鼠标滚轮缩放地图</span></div><div class="line">    regionsSelectable: <span class="literal">true</span>, <span class="comment">// 区域是否可以被选中</span></div><div class="line">    regionsSelectableOne: <span class="literal">false</span>,</div><div class="line">    <span class="attr">regionStyle</span>: &#123; <span class="comment">// 设置区域样式</span></div><div class="line">        initial: &#123; <span class="comment">// 初始状态</span></div><div class="line">            fill: <span class="string">"#58D3F7"</span>,</div><div class="line">            <span class="string">"fill-opacity"</span>: <span class="number">1</span>,</div><div class="line">            <span class="attr">stroke</span>: <span class="string">'none'</span>,</div><div class="line">            <span class="string">"stroke-width"</span>: <span class="number">0</span>,</div><div class="line">            <span class="string">"stroke-opacity"</span>: <span class="number">1</span></div><div class="line">        &#125;,</div><div class="line">        <span class="attr">hover</span>: &#123; <span class="comment">// 当鼠标经过时的状态</span></div><div class="line">            fill: <span class="string">"#0080FF"</span></div><div class="line">        &#125;,</div><div class="line">        <span class="attr">selected</span>: &#123; <span class="comment">// 被选中的状态</span></div><div class="line">            fill: <span class="string">"#00BFFF"</span></div><div class="line">        &#125;,</div><div class="line">        <span class="attr">selectedHover</span>: &#123; <span class="comment">// 当被选中之后鼠标经过的状态</span></div><div class="line">        &#125;</div><div class="line">    &#125;,</div><div class="line">    <span class="attr">markers</span>: markers, <span class="comment">// 初始化标记</span></div><div class="line">    markerStyle: &#123; <span class="comment">// 设置地图标记的样式</span></div><div class="line">        initial: &#123;</div><div class="line">            <span class="attr">fill</span>: <span class="string">'#FFBF00'</span></div><div class="line">        &#125;,</div><div class="line">        <span class="attr">hover</span>: &#123;</div><div class="line">        &#125;,</div><div class="line">        <span class="attr">selected</span>: &#123;</div><div class="line">            <span class="attr">fill</span>: <span class="string">'#FA5858'</span></div><div class="line">        &#125;,</div><div class="line">        <span class="attr">selectedHover</span>: &#123;</div><div class="line">        &#125;</div><div class="line">    &#125;,</div><div class="line">    <span class="attr">labels</span>: &#123;</div><div class="line">        <span class="attr">regions</span>: &#123;</div><div class="line">            <span class="attr">render</span>: <span class="function"><span class="keyword">function</span>(<span class="params">code</span>) </span>&#123;</div><div class="line">                <span class="keyword">return</span> names[code];</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;,</div><div class="line">    <span class="comment">// 区域标签展开时执行事件</span></div><div class="line">    onRegionTipShow: <span class="function"><span class="keyword">function</span>(<span class="params">event, label, code</span>) </span>&#123;</div><div class="line">        label.html(names[code]); <span class="comment">// 返回标签内容</span></div><div class="line">    &#125;</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<blockquote>
<p>參考網站：<br><a href="http://blog.wangjunfeng.com/archives/483" target="_blank" rel="external">Jvectormap中文帮助文档（API）</a><br><a href="http://www.u396.com/jvectormap" target="_blank" rel="external">u396整理的JVectorMap文章</a></p>
</blockquote>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel sidebar-panel-active">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/icon.jpg"
               alt="Mandag" />
          <p class="site-author-name" itemprop="name">Mandag</p>
           
              <p class="site-description motion-element" itemprop="description">动漫，美剧，电影爱好者</p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">19</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          

          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

        


      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy;  2016 - 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Mandag</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Muse
  </a>
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  






  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.0"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.0"></script>



  


  




	





  





  





  






  




  
  
  
  <link rel="stylesheet" href="/lib/algolia-instant-search/instantsearch.min.css">

  
  
  <script src="/lib/algolia-instant-search/instantsearch.min.js"></script>
  

  <script src="/js/src/algolia-search.js?v=5.1.0"></script>



  

  

  

  

</body>
</html>
